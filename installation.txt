
## üöÄ Installation

### √âtape 1 : Installation de TeslaMate

> **‚ö†Ô∏è Important** : TeslaMate doit √™tre install√© et fonctionnel AVANT d'installer TeslaMate Mail.

#### Installation standard de TeslaMate

```bash
# 1. Cr√©er le r√©pertoire
sudo mkdir -p /opt/teslamate
cd /opt/teslamate

# 2. T√©l√©charger docker-compose.yml
sudo wget https://raw.githubusercontent.com/teslamate-org/teslamate/master/docker-compose.yml

# 3. √âditer la configuration
sudo nano docker-compose.yml
```

**Configuration minimale requise** :
```yaml
services:
  teslamate:
    environment:
      - DATABASE_USER=teslamate
      - DATABASE_PASS=votre_mot_de_passe
      - DATABASE_NAME=teslamate
      - MQTT_HOST=mosquitto
    ports:
      - 4000:4000
    
  database:
    environment:
      - POSTGRES_USER=teslamate
      - POSTGRES_PASSWORD=votre_mot_de_passe
      - POSTGRES_DB=teslamate
    ports:
      - "5432:5432"  # ‚ö†Ô∏è OBLIGATOIRE pour TeslaMate Mail
```

#### D√©marrage de TeslaMate

```bash
# Lancer TeslaMate
sudo docker-compose up -d

# V√©rifier que tout fonctionne
sudo docker-compose ps
```

#### Configuration initiale

1. Acc√©dez √† `http://IP_SERVEUR:4000`
2. Suivez l'assistant de configuration
3. Connectez votre compte Tesla apr√®s avoir g√©n√©r√© les jetons (Token) en suivant ce tutoriel : https://www.myteslamate.com/fr/jeton-tesla/
4. Attendez que les premi√®res donn√©es soient collect√©es

---

### √âtape 2 : Installation de TeslaMate Mail

t√©l√©charger les fichiers depuis https://github.com/infrarik/teslamatemail
Vous avez besoin de :
. files.zip
.install.sh
.uninstall.sh si vous souhaitez d√©sinstaller Teslamate-Mail uniquement (cela ne d√©sinstallera pas Teslamate, ne le modifiera pas non plus)

#### Lancement de l'installation

```bash
# Rendre le script ex√©cutable
chmod +x install.sh

# Lancer l'installation en tant que root
bash install.sh

##### üìß Configuration Email

```
Hostname du serveur : teslamate.mondomaine.fr
Serveur SMTP : mail.mondomaine.fr
Port SMTP : 465 (SMTPS) ou 587 (STARTTLS)
Login SMTP : notifications@mondomaine.fr
Mot de passe SMTP : ********
Email exp√©diteur : noreply@mondomaine.fr
Email destinataire : mon-email@gmail.com
```

##### üîî Configuration MQTT (Optionnel)

Installer Mosquitto ? (o/N) : o
Port d'√©coute : 1883
Cr√©er un utilisateur ? (O/n) : o
Nom d'utilisateur : teslamate
Mot de passe : ******** (saisi 2 fois)
```

Le script installe automatiquement :
- ‚úÖ Apache2 + PHP
- ‚úÖ PostgreSQL client
- ‚úÖ Postfix (serveur mail)
- ‚úÖ Mosquitto (si choisi)
- ‚úÖ Configuration automatique
- ‚úÖ Cron pour surveillance

#### Dur√©e d'installation

‚è±Ô∏è **5 √† 10 minutes** selon votre connexion

---

### √âtape 3 : Configuration via l'interface web

#### Acc√®s √† l'interface

Une fois l'installation termin√©e, acc√©dez √† :

```
http://IP_SERVEUR/index.php
```

Ou directement √† la configuration :

```
http://IP_SERVEUR/teslaconf.php
```

#### Configuration TeslaMate Mail

**1. Configuration MQTT** (si non install√© automatiquement)
- H√¥te : `localhost` ou IP du broker
- Port : `1883`
- Utilisateur : (optionnel)
- Mot de passe : (optionnel)
- Topic : `teslamate/cars/1`

**2. Configuration Email**
- Email de notification : votre email

**3. Configuration Docker**
- Chemin : `/opt/teslamate/docker-compose.yml`
- Le script d√©tecte automatiquement ce chemin


**4. Configuration Telegram**
- Vous aurez besoin d'un token pour cr√©er un Bot t√©l√©gram, Bot qui sera utilis√© par Teslamate-Mail.
- Il faudra indiquer les informations sur l'utilisateur √† qui envoyer les informations : le nom (@xxxx), le ChatID (12345678).
Tutoriel conseill√© : https://az-tools.com/actu/creer-un-bot-telegram-etapes-simples-pour-recuperer-le-token-et-lid-de-chat/#:~:text=R%C3%A9cup%C3%A9rer%20ton%20ID%20de%20chat%20Telegram,-Pour%20interagir%20avec&text=Envoyez%20un%20message%20%C3%A0%20votre,(par%20exemple%20%3A%20Hello%20).&text=%E2%9E%A1%20Ce%20nombre%20(%20123456789%20)%20est%20votre%20ID%20de%20chat%20Telegram.


**4. Activer les notifications**
- ‚úÖ Cocher "Activer les notifications MQTT"
- ‚úÖ Cocher "Activer les notifications Email"
- ‚úÖ Cocher "Activer les notifications Telegram"

!!! IMPORTANT : √† chaque changement de configuration, il faut r√©activer les notifications !!!

#### Sauvegarde

Cliquez sur **"Enregistrer la configuration"** et attendez le message de confirmation.

---

## ‚öôÔ∏è Configuration

### Personnalisation du cron

Par d√©faut, le script v√©rifie les nouvelles charges toutes les **5 minutes**.

Pour modifier :

# √âditer le crontab
sudo crontab -e

# Modifier la ligne (exemple : toutes les 10 minutes)
*/10 * * * * /root/teslacharge.sh >> /var/log/teslacharge.log 2>&1
```

### Configuration Postfix avanc√©e

Le fichier de configuration est dans `/etc/postfix/main.cf`

```bash
# √âditer
sudo nano /etc/postfix/main.cf

# Red√©marrer apr√®s modification
sudo systemctl restart postfix
```

### V√©rification des logs

```bash
# Logs des emails
sudo tail -f /var/log/mail.log

# Logs du script de surveillance
sudo tail -f /var/log/teslacharge.log

# Logs Apache
sudo tail -f /var/log/apache2/error.log

# Logs Mosquitto (si install√©)
sudo journalctl -u mosquitto -f
```

---

## üì± Utilisation

### Dashboard principal

Acc√®s : `http://IP_SERVEUR/tesla.html`

- üìä Vue d'ensemble des charges r√©centes
- üó∫Ô∏è Carte interactive avec les lieux de charge
- üìà Statistiques en temps r√©el

### Consultation de l'historique

Acc√®s : `http://IP_SERVEUR/teslaliste.php`

- Liste des 10 derni√®res charges
- D√©tails complets pour chaque charge
- Filtres et recherche

### Rapports de consommation

Acc√®s : `http://IP_SERVEUR/teslacalcul.php`

**Fonctionnalit√©s** :
1. S√©lectionner une p√©riode (d√©but/fin)
2. Filtrer par lieu (geofence)
3. Choisir le format d'export :
   - üìß Email
   - üìÑ PDF
   - üìä CSV

**Export complet** :
- ‚úÖ Cocher "Export complet" pour obtenir :
  - Date et heure de chaque charge
  - Position GPS exacte
  - kWh ajout√©s
  - Dur√©e de la charge

### Notifications email

Les emails sont envoy√©s automatiquement apr√®s chaque charge et contiennent :
- üìÖ Date et heure
- üìç Lieu (si geofence configur√©e)
- ‚ö° √ânergie ajout√©e (kWh)
- üí∞ Co√ªt estim√©
- ‚è±Ô∏è Dur√©e de la charge

---

## üîç D√©pannage

### Probl√®me : Aucun email re√ßu

# V√©rifier le statut de Postfix
sudo systemctl status postfix

# V√©rifier les logs
sudo tail -f /var/log/mail.log

# Tester l'envoi manuel
echo "Test" | mail -s "Test TeslaMate" votre-email@exemple.com
```

**Solutions courantes** :
- V√©rifier les identifiants SMTP
- V√©rifier que le port est correct (465 ou 587)
- V√©rifier les r√®gles firewall
- V√©rifier que le serveur SMTP autorise l'envoi

### Probl√®me : Erreur de connexion √† la base de donn√©es

# V√©rifier que PostgreSQL est expos√©
sudo docker-compose -f /opt/teslamate/docker-compose.yml ps

# V√©rifier le port 5432
sudo netstat -tulpn | grep 5432

# Tester la connexion
psql -h localhost -U teslamate -d teslamate
```

**Solution** :

# √âditer docker-compose.yml
sudo nano /opt/teslamate/docker-compose.yml

# Ajouter sous 'database:' :
    ports:
      - "5432:5432"

# Red√©marrer
sudo docker-compose -f /opt/teslamate/docker-compose.yml restart
```

### Probl√®me : Interface web inaccessible


# V√©rifier Apache
sudo systemctl status apache2

# V√©rifier les permissions
ls -la /var/www/html/

# Red√©marrer Apache
sudo systemctl restart apache2
```

### Probl√®me : MQTT ne fonctionne pas

# V√©rifier Mosquitto
sudo systemctl status mosquitto

# Tester la connexion
mosquitto_pub -h localhost -t "test" -m "hello"
mosquitto_sub -h localhost -t "test"

# V√©rifier les logs
sudo journalctl -u mosquitto -n 50
```

### Probl√®me : Script cron ne s'ex√©cute pas


# V√©rifier le cron
sudo crontab -l

# V√©rifier les logs
sudo tail -f /var/log/teslacharge.log

# Ex√©cution manuelle pour tester
sudo /root/teslacharge.sh
```

---

## üôè Remerciements

- [TeslaMate](https://github.com/teslamate-org/teslamate) - Le projet principal
- La communaut√© TeslaMate pour le support
- Tous les contributeurs

---

**D√©velopp√© avec ‚ù§Ô∏è pour la communaut√© Tesla**
